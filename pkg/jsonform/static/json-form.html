<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>Form</title>
    <link rel="stylesheet" type="text/css" href="/static/bootstrap.css"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="/static/favicon.png" type="image/png"/>
    <link rel="stylesheet" href="/static/pure.css">

</head>
<body>

<div style="margin:2em" class="pure-u-2-5">
    <h1 id="title"></h1>
    <form id="schema-form" class="pure-form"></form>
    <div id="res" class="alert"></div>
</div>

<script type="text/javascript" src="/static/jquery-3.6.3.min.js"></script>
<script type="text/javascript" src="/static/underscore.js"></script>
<script type="text/javascript" src="/static/jsv.js"></script>
<script type="text/javascript" src="/static/jsonform.js"></script>
<script type="text/javascript">
    var query = window.location.search.substring(1);

    var params = query.split('&').reduce(function (res, item) {
        var parts = item.split('=');
        res[parts[0]] = decodeURIComponent(parts[1]);
        return res;
    }, {});

    if (params.title) {
        $("#title").text(params.title)
        document.title = params.title
    }
    console.log("HASH PARAMS:", params)

    if (params.schema !== null && params.value !== null) {
        send(params.schema, "GET", null, 200, function (schema) {
            console.log("SCHEMA:", schema)

            if (!params.title) {
                $("#title").text(schema.schema.title)
                document.title = schema.schema.title
            }

            send(params.value, "GET", null, 200, function (value) {
                $('#schema-form').jsonForm({
                    schema: schema.schema,
                    form: schema.form,
                    value: value,
                    onSubmit: function (errors, values) {
                        $('#res').text("")

                        if (errors) {
                            console.log(errors)
                            return
                        }

                        if (params.submitUrl && params.submitMethod) {
                            send(params.submitUrl, params.submitMethod, values, 0, function () {
                                $('#res').text("Submitted.")
                            })

                        }
                    }
                });
            });
        });
    }

    function send(url, method, bodyValues, successStatus, successCB) {
        var x = new XMLHttpRequest();
        x.onreadystatechange = function () {
            if (x.readyState !== XMLHttpRequest.DONE) {
                return;
            }

            if (!successStatus) {
                if (typeof (successCB) === 'function') {
                    successCB(x);
                }

                return
            }

            switch (x.status) {
                case successStatus:
                    if (typeof (successCB) === 'function') {
                        successCB(JSON.parse(x.responseText));
                    }
                    break;
                default:
                    throw {err: 'unexpected response', data: x};
            }
        };


        x.open(method, url, true);
        if (typeof bodyValues !== null) {
            x.setRequestHeader("Content-Type", "application/json; charset=utf-8");
            x.send(JSON.stringify(bodyValues));
            return;
        }

        x.send();
    }
</script>
</body>
</html>