<!DOCTYPE html>
<html lang="en">
<head>
    <title>{{.Title}}</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="/static/favicon.png" type="image/png"/>
    <link rel="stylesheet" href="/static/pure.css">
    <link rel="stylesheet" href="/static/photoswipe.css">

    <script src="/static/jquery-3.6.3.min.js"></script>
    <script src="/static/client.js"></script>
    <script src="/static/photoswipe.umd.min.js"></script>
    <script src="/static/photoswipe-lightbox.umd.min.js"></script>

    <meta property="og:title" content="{{.Title}}"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="{{.CoverImage}}"/>

    <meta name="robots" content="noindex">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
          integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI="
          crossorigin=""/>
    <!-- Make sure you put this AFTER Leaflet's CSS -->
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"
            integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM="
            crossorigin=""></script>

    <style>
        .image-marker {
            border-radius: 20%;
        }
    </style>
</head>
<body>

<div style="margin:2em">
    <h1 id="album-title">{{.Title}}</h1>

    <div class="gallery"></div>

    <div class="gallery-pano" style="display:none">
        <h2>Panoramas</h2>

    </div>

    <div id="map" style="height:500px; margin-top:40px; display: none"></div>

    <a href="/album/{{.Name}}.zip">Download all photos (zip).</a>
</div>


<script>
    var openByHash

    (function () {
        "use strict";

        var gpsBounds = {
            minLat: null,
            maxLat: null,
            minLng: null,
            maxLng: null
        };


        /**
         * @type {Array<PhotoGps>}
         */
        var gpsMarkers = []
        var client = new Backend('');

        client.getAlbumNameJson({
            name: "{{.Name}}"
        }, function (result) {
            var hashByIdx = {}
            var idxByHash = {}

            for (var i = 0; i < result.images.length; i++) {
                var img = result.images[i]
                hashByIdx[i] = img.hash
                idxByHash[img.hash] = i

                if (typeof img.gps != 'undefined') {
                    gpsMarkers.push(img.gps)
                    if (gpsBounds.maxLat == null) {
                        gpsBounds.maxLat = img.gps.latitude
                        gpsBounds.minLat = img.gps.latitude
                        gpsBounds.maxLng = img.gps.longitude
                        gpsBounds.minLng = img.gps.longitude
                    } else {
                        if (img.gps.longitude > gpsBounds.maxLng) {
                            gpsBounds.maxLng = img.gps.longitude
                        }
                        if (img.gps.longitude < gpsBounds.minLng) {
                            gpsBounds.minLng = img.gps.longitude
                        }
                        if (img.gps.latitude > gpsBounds.maxLat) {
                            gpsBounds.maxLat = img.gps.latitude
                        }
                        if (img.gps.latitude < gpsBounds.minLat) {
                            gpsBounds.minLat = img.gps.latitude
                        }
                    }
                }

                if (img.exif.projection_type == "") {
                    var a = $("<a>")
                    a.attr("id", 'img' + img.hash)
                    a.attr("href", "/image/" + img.hash + ".jpg")
                    a.attr("data-pswp-width", img.width)
                    a.attr("data-pswp-height", img.height)
                    a.attr("target", "_blank")
                    a.attr("data-pswp-srcset",
                        "/thumb/300w/" + img.hash + ".jpg 300w" +
                        ", /thumb/600w/" + img.hash + ".jpg 600w" +
                        ", /thumb/1200w/" + img.hash + ".jpg 1200w" +
                        ", /thumb/2400w/" + img.hash + ".jpg 2400w" +
                        // ""
                        ", /image/" + img.hash + ".jpg " + img.width + "w"
                    )
                    a.html('<img src="/thumb/200h/' + img.hash + '.jpg" srcset="/thumb/400h/' + img.hash + '.jpg 2x" />')

                    $(".gallery").append(a)
                } else {
                    var a = $("<a>")
                    a.attr("id", 'img' + img.hash)
                    a.attr("href", "/{{.Name}}/pano-" + img.hash + ".html")
                    a.html('<img src="/thumb/200h/' + img.hash + '.jpg" srcset="/thumb/400h/' + img.hash + '.jpg 2x" />')

                    $(".gallery-pano").show().append(a)
                }
            }

            var lightbox = new PhotoSwipeLightbox({
                gallery: '.gallery',
                children: 'a',
                // dynamic import is not supported in UMD version
                pswpModule: PhotoSwipe
            });
            lightbox.init();

            openByHash = function (hash) {
                lightbox.loadAndOpen(idxByHash[hash], {gallery: document.querySelector('.gallery')});
            }

            if (window.location.hash) {
                var hashname = window.location.hash.substring(1);

                if (idxByHash[hashname]) {
                    openByHash(hashname)
                }
            }

            lightbox.on('change', function () {
                window.location.hash = '#' + hashByIdx[lightbox.pswp.currSlide.index]
            })

            lightbox.on('close', function () {
                history.pushState("", document.title, window.location.pathname
                    + window.location.search);
            })

            if (gpsBounds.minLat != null) {
                $('#map').show()
                var map = L.map('map').fitBounds([
                    [gpsBounds.minLat, gpsBounds.minLng],
                    [gpsBounds.maxLat, gpsBounds.maxLng]
                ]);
                L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
                }).addTo(map);

                for (var i = 0; i < gpsMarkers.length; i++) {
                    var m = gpsMarkers[i]
                    L.marker([m.latitude, m.longitude],
                        {
                            icon: L.icon({
                                iconUrl: '/thumb/300w/' + m.hash + '.jpg',
                                iconSize: [40],
                                className: 'image-marker'
                            })
                        })
                        .addTo(map)
                        .bindPopup(
                            L.popup()
                                .setContent(
                                    '<p>Pos: ' + m.latitude.toFixed(6) + ',' + m.longitude.toFixed(6) + ', Alt: ' + m.altitude + 'm</p>' +
                                    '<a href="#" onclick="openByHash(\'' + m.hash + '\');return false">' +
                                    '<img style="width: 300px" src="/thumb/300w/' + m.hash + '.jpg" srcset="/thumb/600w/' + m.hash + '.jpg 2x" /></a>'
                                )
                        )
                }
            }
        }, function (error) {

        }, function (error) {

        })
    })();
</script>
</body>
</html>